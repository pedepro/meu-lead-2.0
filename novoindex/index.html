<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="../assets/icon.ico">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/coolvetica" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Imóveis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f4f7f6;
            transition: margin-left 0.3s ease;
            padding-top: 70px;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1500;
            gap: 10px;
        }
        header h1 {
            font-size: 22px;
            color: #333;
        }
        header img {
            height: 50px;
        }
        .menu-toggle {
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            color: #333;
        }
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            background-color: white;
            border-right: 2px solid #ddd;
            overflow-x: hidden;
            transition: 0.3s ease;
            z-index: 1;
            padding-top: 80px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
            width: 250px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 15px;
            text-align: left;
        }
        .sidebar ul li a {
            text-decoration: none;
            font-size: 18px;
            color: #333;
            display: block;
            transition: background 0.3s;
        }
        .sidebar ul li a:hover {
            background-color: #ddd;
        }
        .sidebar ul li:has(#meusleads-link),
        .sidebar ul li:has(#meusimoveis-link),
        .sidebar ul li:has(#editar-perfil-link),
        #logout-icon {
            display: none !important;
        }
        .logged-in .sidebar ul li:has(#meusleads-link),
        .logged-in .sidebar ul li:has(#meusimoveis-link),
        .logged-in .sidebar ul li:has(#editar-perfil-link),
        .logged-in #logout-icon {
            display: block !important;
        }
        .main-content {
            transition: margin-left 0.3s ease;
            padding: 20px;
        }
    </style>
</head>
<body>
    <header>
        <button class="menu-toggle">☰</button>
        <img src="../assets/logohorizontal.png" alt="Descrição da imagem">
    </header>

    <nav class="sidebar">
        <ul>
            <li><a href="?session=imoveis" id="imoveis-link">Imóveis</a></li>
            <li><a href="?session=leads" id="clientes-link">Leads (Clientes)</a></li>
            <li><a href="?session=meusleads" id="meusleads-link">Meus Leads</a></li>
            <li><a href="?session=meusimoveis" id="meusimoveis-link">Meus Imóveis</a></li>
            <li><a href="?session=editar-perfil" id="editar-perfil-link">Editar Perfil</a></li>
        </ul>
    </nav>

    <main class="main-content" id="main-content"></main>

    <script>
        // Função para sincronizar localStorage com cookies
        function syncLocalStorageToCookies() {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("userId");

            if (token) {
                document.cookie = `token=${token}; path=/; domain=.meuleaditapema.com.br; SameSite=Lax`;
            } else {
                document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.meuleaditapema.com.br;";
            }

            if (userId) {
                document.cookie = `userId=${userId}; path=/; domain=.meuleaditapema.com.br; SameSite=Lax`;
            } else {
                document.cookie = "userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.meuleaditapema.com.br;";
            }
        }

        // Função para sincronizar cookies com localStorage
        function syncCookiesToLocalStorage() {
            const cookies = document.cookie.split("; ").reduce((acc, cookie) => {
                const [key, value] = cookie.split("=");
                acc[key] = value;
                return acc;
            }, {});

            if (cookies.token && !localStorage.getItem("token")) {
                localStorage.setItem("token", cookies.token);
            }
            if (cookies.userId && !localStorage.getItem("userId")) {
                localStorage.setItem("userId", cookies.userId);
            }
        }

        // Função para verificar login
        async function verificarLogin() {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("userId");

            if (!token || !userId) {
                window.location.href = "/login";
                return false;
            }

            try {
                const url = `https://pedepro-meulead.6a7cul.easypanel.host/corretor?id=${userId}&token=${token}`;
                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                const data = await response.json();

                if (response.ok && !data.error) {
                    document.body.classList.add("logged-in"); // Adiciona classe para exibir itens de usuário logado
                    return true;
                } else {
                    console.log("Credenciais inválidas ou erro na resposta:", data.error);
                    localStorage.removeItem("token");
                    localStorage.removeItem("userId");
                    syncLocalStorageToCookies();
                    window.location.href = "/login";
                    return false;
                }
            } catch (error) {
                console.error("Erro ao verificar login no servidor:", error);
                window.location.href = "/login";
                return false;
            }
        }

        // Função para obter o parâmetro de sessão
        function getSessionParam() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('session') || 'imoveis';
        }

        // Função para carregar conteúdo dinâmico
        async function loadContent(session) {
            const mainContent = document.getElementById('main-content');
            let htmlFileToLoad = '';
            let jsFileToLoad = '';
            let cssFileToLoad = '';

            switch (session) {
                case 'imoveis':
                    htmlFileToLoad = 'imoveis.html';
                    jsFileToLoad = 'imoveis.js';
                    cssFileToLoad = 'imoveis.css';
                    break;
                case 'leads':
                    htmlFileToLoad = 'leads.html';
                    jsFileToLoad = 'leads.js';
                    cssFileToLoad = 'leads.css';
                    break;
                case 'meusleads':
                    htmlFileToLoad = 'meusleads.html';
                    jsFileToLoad = 'meusleads.js';
                    cssFileToLoad = 'meusleads.css';
                    break;
                case 'meusimoveis':
                    htmlFileToLoad = 'meusimoveis.html';
                    jsFileToLoad = 'meusimoveis.js';
                    cssFileToLoad = 'meusimoveis.css';
                    break;
                case 'editar-perfil':
                    htmlFileToLoad = 'editar-perfil.html';
                    jsFileToLoad = 'editar-perfil.js';
                    cssFileToLoad = 'editar-perfil.css';
                    break;
                default:
                    htmlFileToLoad = 'imoveis.html';
                    jsFileToLoad = 'imoveis.js';
                    cssFileToLoad = 'imoveis.css';
            }

            const isLoggedIn = await verificarLogin();
            if (!isLoggedIn) return;

            // Carrega o HTML
            fetch(htmlFileToLoad)
                .then(response => {
                    if (!response.ok) throw new Error('Arquivo HTML não encontrado');
                    return response.text();
                })
                .then(data => {
                    mainContent.innerHTML = data;

                    // Remove scripts e estilos anteriores para evitar duplicatas
                    const existingScripts = document.querySelectorAll('script[data-dynamic]');
                    existingScripts.forEach(script => script.remove());
                    const existingStyles = document.querySelectorAll('link[data-dynamic]');
                    existingStyles.forEach(style => style.remove());

                    // Carrega o CSS
                    if (cssFileToLoad) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = cssFileToLoad;
                        link.setAttribute('data-dynamic', 'true');
                        link.onload = () => console.log(`${cssFileToLoad} carregado com sucesso`);
                        link.onerror = () => console.error(`Erro ao carregar ${cssFileToLoad}`);
                        document.head.appendChild(link);
                    }

                    // Carrega o JS
                    if (jsFileToLoad) {
                        const script = document.createElement('script');
                        script.src = jsFileToLoad;
                        script.setAttribute('data-dynamic', 'true');
                        script.onload = () => console.log(`${jsFileToLoad} carregado com sucesso`);
                        script.onerror = () => console.error(`Erro ao carregar ${jsFileToLoad}`);
                        document.body.appendChild(script);
                    }
                })
                .catch(error => {
                    mainContent.innerHTML = '<p>Erro ao carregar o conteúdo. Tente novamente.</p>';
                    console.error(error);
                });
        }

        // Evento para abrir/fechar sidebar
        document.querySelector('.menu-toggle').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.main-content').style.marginLeft = 
                document.querySelector('.sidebar').classList.contains('open') ? '250px' : '0';
        });

        // Carrega conteúdo ao iniciar
        window.onload = async () => {
            syncCookiesToLocalStorage(); // Sincroniza cookies para localStorage ao carregar
            const session = getSessionParam();
            await loadContent(session);
            syncLocalStorageToCookies(); // Sincroniza localStorage para cookies após carregar
        };

        // Carrega novo conteúdo ao clicar nos links da sidebar
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const session = new URLSearchParams(link.search).get('session');
                await loadContent(session);
                window.history.pushState({}, '', `?session=${session}`);
            });
        });
    </script>
</body>
</html>